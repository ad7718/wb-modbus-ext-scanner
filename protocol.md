
# РАСШИРЕНИЕ MODBUS WIRENBOARD

Работа в расширенном режиме происходит через зарезервированный адрес 0xFD и команду 0x60

## Сканирование шины

После включения устройство считает что оно не сканировано. Возможно сканировать только устройства которые считают что они не сканированны и только 1 раз.

### Функция начала сканирования - 0x01

Приняв эту команду устройства начинают считать себя не сканироваными. Далее все участвуют в арбитраже и устройство с меньшим серийным номером отправляет ответ на сканирование с данными о себе.

* (1 байт)    `0xFD`    широковещательный адрес
* (1 байт)    `0x60`    команда работы с расширенными функциями
* (1 байт)    `0x01`    суб команда начала сканирования
* (2 байта)             контрольная сумма

`Пример: FD 60 01 09 F0`

### Функция продолжения сканирования - 0x02

Далее мастер может продолжить сканировать шину отправляя эту команду. Устройство которые еще не отправили информацию о себе устраивают арбитраж и то одно с меньшим серийным номером отправляет ответ на сканирование с данными о себе.

* (1 байт)    `0xFD`    широковещательный адрес
* (1 байт)    `0x60`    команда работы с расширенными функциями
* (1 байт)    `0x02`    суб команда сканирования одного устройства
* (2 байта)             контрольная сумма

`Пример: FD 60 02 49 F1`

### Функция ответа на сканирование - 0x03

Все устройства на шине получают команду, после 3.5 фреймов молчания на шине, независимо от настройки задержки ответа, происходит нечто, под названием арбитраж. Выглядит это как периодически отправляющиеся на шину байты со значением 0xFF. В недалеком будущем устройства решают кто будет передавать, при этом они понимают есть ли вообще не сканированные устрорйства. Некоторое устройство выигравшее арбитраж передает пакет с информацией о себе, имеющий следующую структуру:

* (1 байт)    `0xFD`    широковещательный адрес
* (1 байт)    `0x60`    команда работы с расширенными функциями
* (1 байт)    `0x03`    суб команда - признак ответа на сканирование
* (4 байта)             серийный номер устройства
* (1 байт)              модбас адрес устройства
* (2 байта)             контрольная сумма

`Пример: FF FF FF FF FF FF FF FF FF FD 60 03 FE 11 F1 D9 01 09 A8`

При этом мастер игнорирует байты со значением 0xFF, пока не получит кадр ответа. По ответу мастеру желательно запомнить все найденые устройства и их модбас адреса. В случае повторения модбас адреса его можно изменить, идентифицируя устройство по серийному номеру.

Между запросами сканирования мастер может выполнить любую команду, например считать информацию об устройстве или поменять адрес адресуя устройства по серийному номеру.

### Функция конца сканирования - 0x04

Мастер повторяет запрос сканирования пока все устройства не будут сосканированны. Если не сканированных устройств не осталось то ответит устройство с наименьшим значением серийного номера, и в ответе сообщит о том что не сканированных устройств не осталось. Таким образом мы избавляем мастер от необходимости ждать таймауты.

* (1 байт)    `0xFD`    широковещательный адрес
* (1 байт)    `0x60`    команда работы с расширенными функциями
* (1 байт)    `0x04`    суб команда - признак завершения сканирования
* (2 байта)             контрольная сумма

`Пример: FF FF FF FF FF FF FF FF FF FD 60 04 C9 F3`

Запрос сканирования можно переодически повторять и таким образом например понять, что было подключено новое устройство, или какоето из устройств перезагрузилось.

## Порядок сканирования

Мастер выбирает настройки скорости и четности, отправляет на них команду начала сканирования (`0x01`). Далее необходимо подождать стандартное время 3,5 фрейма и после этого если на шине есть устройства, то одно из них вернет ответ на сканирование командой `0x03`. Необходимо игнорировать все предшествующие байты `0xFF`. Если после времени ождиания ответа нет то на шине нет устройств с данными настройками. Можно переходить к сканированию на других настройках порта. Если был ответ то после него можно отправить команду команду продолжения сканирования (`0x02`) и получить данные о следующем устройстве. Это можно повторять пока не придет ответ об окончании сканирования (`0x04`).

## Работа с устройствами по серийному номеру

Если кактое устройства имеют одинаковый модбас адрес работать с ними через обычные модбас функции нельзя. Например мы просканировали шину и хотим запросить модели устройств или версию прошивки до смены адреса. Предусмотрена возможность работать с устройством через его серийный номер. Адрес становится известен на этапе сканирования или доступен на наклейке. Есть возможность завернуть стандартную команду в пакет использующий серийный номер вместо модбас адреса.

### Функция отправки стандартной команды - 0x08

* (1 байт)    `0x00`    широковещательный адрес
* (1 байт)    `0x60`    команда работы с расширенными функциями
* (1 байт)    `0x08`    суб команда эмуляции стандартных запросов
* (4 байта)             серийный номер устройства к которому обращаемся
--- обычный PDU ---
* (1 байт)              стандарный код функции работы с регистрами (1-4, 5, 6, 15, 16)
  ...                   тело запроса
--- обычный запрос ---
* (2 байта)             контрольная сумма

`Пример: FD 60 08 FE 11 F1 D9 03 00 68 00 02 8A 44`

### Функция ответа на стандартную команду - 0x09
В результате устройство отвечает пакет

* (1 байт)    `0x00`    широковещательный адрес
* (1 байт)    `0x60`    команда работы с расширенными функциями
* (1 байт)    `0x09`    суб команда эмуляции стандартных запросов
* (4 байта)             серийный номер устройства к которому обращаемся
--- обычный PDU ---
* (1 байт)              стандарный код функции работы с регистрами (1-4, 5, 6, 15, 16)
  ...                   тело ответа
--- обычный запрос ---
* (2 байта)             контрольная сумма

`Пример: FD 60 09 FE 11 F1 D9 03 04 00 00 3B 9E BF 03`
